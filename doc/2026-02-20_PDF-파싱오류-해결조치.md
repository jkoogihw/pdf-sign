# PDF 파싱 오류 해결

## 문제 상황
```
오류: Failed to parse PDF document (line:0 col:0 offset=0): No PDF header found
```

사용자가 PDF 파일과 서명 파일을 업로드하여 서명 처리 시 PDF 파싱에 실패하는 오류 발생.

---

## 원인 분석

### 1. PDF 헤더 정규화 불일치
- `normalizePdfBytes()` 함수는 PDF-Lib에서만 정규화된 바이트를 사용
- **pdf.js 라이브러리는 정규화되지 않은 원본 바이트를 받음**
- PDF 파일에 BOM(Byte Order Mark) 또는 앞부분 잡음 바이트가 있으면 pdf.js 파싱 실패

### 2. 오류 처리 부족
- pdf.js 파싱 실패 시 상세 오류 메시지 불가
- 서명 위치 탐색 실패 시 전체 프로세스 중단

---

## 해결 방법

### 수정 사항

#### 1) `findAgentAnchor()` 함수 개선
**변경 전:**
```javascript
async function findAgentAnchor(pdfBytes) {
  const doc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
  // ...
}
```

**변경 후:**
```javascript
async function findAgentAnchor(pdfBytes) {
  // PDF 헤더를 확인하고 필요하면 정규화 (PDF.js도 normalize 필요)
  const normalizedBytes = (() => {
    try {
      return normalizePdfBytes(pdfBytes);
    } catch (e) {
      console.warn('PDF 정규화 실패, 원본 사용:', e.message);
      return pdfBytes;
    }
  })();
  
  const doc = await pdfjsLib.getDocument({ data: normalizedBytes }).promise;
  // ...
}
```

#### 2) `signPdf()` 함수 개선
- 디버깅 로그 추가 (바이트 크기 확인)
- 서명 위치 탐색 오류 처리 (try-catch 추가)
- 기본 위치 사용으로 안정성 향상

---

## 코드 변경 내용

### 주요 개선사항

#### ✅ PDF 정규화 일관성
- pdf.js도 정규화된 바이트 사용
- BOM/앞부분 잡음 바이트 자동 처리

#### ✅ 향상된 오류 처리
```javascript
try {
  anchor = await findAgentAnchor(pdfBytes);
  if (anchor) {
    console.log('서명 위치 찾음:', anchor);
  } else {
    console.log('서명 위치 미찾음, 기본 위치 사용');
  }
} catch (anchorError) {
  console.warn('서명 위치 탐색 중 오류:', anchorError.message);
  setStatus('경고: 서명 위치 탐색 실패 - 기본 위치에 배치합니다');
}
```

#### ✅ 디버깅 정보
```javascript
console.log('원본 PDF 바이트:', rawPdfBytes.length, '바이트');
console.log('정규화된 PDF 바이트:', pdfBytes.length, '바이트');
console.log('서명 이미지 바이트:', signBytes.length, '바이트');
```

---

## 테스트 및 확인 방법

### 1. 브라우저 개발자 도구 열기
- `F12` 또는 `Ctrl+Shift+I` → Console 탭

### 2. PDF 파일 업로드 및 서명 처리
- 문제가 발생했던 PDF 파일 업로드
- 서명 파일 업로드
- "[서명] PDF 생성" 버튼 클릭

### 3. 콘솔 로그 확인
```
원본 PDF 바이트: 12345 바이트
정규화된 PDF 바이트: 12345 바이트
서명 이미지 바이트: 5678 바이트
서명 위치 찾음: {pageIndex: 0, x: 100, y: 200, ...}
```

### 4. 예상 결과
- **성공 케이스**: "완료! 보험모집인 문구 기준으로 서명을..."
- **위치 미탐색**: "완료! 문구 탐색 실패로 기본 위치에 서명을..."
- **오류 케이스**: 오류 메시지 표시 (상세 디버깅 로그 콘솔에 기록)

---

## 예상 영향도

| 항목 | 상태 |
|------|------|
| **BOM 있는 PDF** | ✅ 정규화로 해결 |
| **URL로 가져온 PDF** | ✅ Content-Type 확인 후 정규화 |
| **서명 위치 탐색 실패** | ✅ 경고 메시지로 기본 위치 사용 |
| **이미지 임베드 실패** | ⚠️ 기존 처리 (추후 개선 가능) |

---

## 파일 변경 사항
- **수정 파일**: `app.js`
- **수정 라인**: `findAgentAnchor()` 함수, `signPdf()` 함수
- **추가 기능**: 콘솔 로그, 향상된 오류 처리, try-catch 블록

---

## 다음 단계

1. ✅ 현재 변경사항 커밋 및 테스트
2. 추가 테스트 케이스 (손상된 PDF, 특수 형식 등)
3. 필요시 추가 라이브러리 업데이트 (pdf.js, pdf-lib 최신 버전)

