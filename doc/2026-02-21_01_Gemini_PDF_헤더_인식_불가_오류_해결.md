# 2026-02-21_01_Gemini_PDF_헤더_인식_불가_오류_해결.md

## 1. 문제 현상
- PDF 파일을 업로드하거나 URL로 불러온 뒤 "서명 처리"를 시도할 때, `실패: Failed to parse PDF document (line:0 col:0 offset=0): No PDF header found` 오류가 발생함.
- 실제 PDF 파일은 `%PDF-1.4` 헤더를 정상적으로 포함하고 있음에도 불구하고 `pdf-lib` 라이브러리에서 헤더를 찾지 못하는 상황임.

## 2. 원인 분석
- `app.js` 내의 `findAgentAnchor` 함수에서 서명 위치를 찾기 위해 `pdf.js` (pdfjsLib)를 사용함.
- `pdf.js`는 `getDocument` 호출 시 성능 최적화를 위해 입력받은 `ArrayBuffer` 또는 `Uint8Array` 데이터를 워커(Worker) 스레드로 전달하면서 원본 스레드에서의 버퍼를 **비활성화(Transfer/Detach)** 시킴.
- 이로 인해 이후 `pdf-lib` (`PDFDocument.load(pdfBytes)`)에서 동일한 `pdfBytes` 객체를 사용하려 할 때 데이터가 0바이트인 상태가 되어 "헤더를 찾을 수 없다"는 오류가 발생한 것임.

## 3. 조치 내용
- `findAgentAnchor` 함수에서 `pdf.js`에 데이터를 전달할 때, 원본 버퍼의 복사본을 만들어 전달하도록 수정함.
- `new Uint8Array(pdfBytes)`를 통해 새로운 메모리 영역에 데이터를 복제하여 전달함으로써, 워커 스레드로 데이터가 넘어가더라도 메인 스레드의 `pdfBytes`는 그대로 유지되도록 함.

### 수정 코드 (app.js)
```javascript
// 수정 전
const doc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;

// 수정 후
const doc = await pdfjsLib.getDocument({ data: new Uint8Array(pdfBytes) }).promise;
```

## 4. 결과
- 서명 위치 탐색 후에도 `pdfBytes`의 데이터가 보존되어 `pdf-lib`을 통한 서명 삽입 및 PDF 생성이 정상적으로 수행됨.

## 5. 작업 확인 명령어
```powershell
# 서버 재실행 후 브라우저 테스트 진행
powershell -ExecutionPolicy Bypass -File .\server.ps1
```
